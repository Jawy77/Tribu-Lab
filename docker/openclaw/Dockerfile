# =============================================================================
# ðŸ¦ž OpenClaw Bot â€” Hardened Dockerfile
# BÃºnker DevSecOps Workshop â€” Comunidad Claude Anthropic Colombia
# =============================================================================
# Security features:
#   - Multi-stage build (reduce attack surface)
#   - Non-root user
#   - Read-only filesystem
#   - No new privileges
#   - Minimal base image
#   - Health check
# =============================================================================

# â”€â”€ Stage 1: Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM python:3.12-slim AS builder

WORKDIR /build

# Instalar dependencias del sistema para compilaciÃ³n
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        gcc \
        libffi-dev \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir --prefix=/install -r requirements.txt

# â”€â”€ Stage 2: Runtime (Hardened) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM python:3.12-slim AS runtime

# Metadata
LABEL maintainer="Mantishield <security@mantishield.com>"
LABEL description="OpenClaw Bot â€” Hardened for BÃºnker DevSecOps"
LABEL workshop="Comunidad Claude Anthropic Colombia"

# Crear usuario no-root
RUN groupadd -r openclaw && \
    useradd -r -g openclaw -d /app -s /sbin/nologin openclaw

# Copiar solo las dependencias compiladas
COPY --from=builder /install /usr/local

# Instalar solo lo mÃ­nimo necesario en runtime
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        tini \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get purge -y --auto-remove

# Directorio de la app
WORKDIR /app

# Copiar cÃ³digo de la aplicaciÃ³n
COPY --chown=openclaw:openclaw . .

# Directorio para datos temporales (writable)
RUN mkdir -p /app/tmp /app/logs && \
    chown -R openclaw:openclaw /app/tmp /app/logs

# Configurar DNS (necesario para descargar modelos)
RUN echo "nameserver 8.8.8.8" > /etc/resolv.conf.override

# Cambiar a usuario no-root
USER openclaw

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# Usar tini como init (PID 1 correcto, signal handling)
ENTRYPOINT ["tini", "--"]

# Ejecutar la aplicaciÃ³n
CMD ["python", "-m", "openclaw.main"]

# â”€â”€ Security Labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Estas labels documentan la postura de seguridad del container
LABEL security.read-only-rootfs="true"
LABEL security.no-new-privileges="true"
LABEL security.non-root-user="openclaw"
