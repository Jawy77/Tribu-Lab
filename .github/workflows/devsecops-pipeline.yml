# =============================================================================
# üõ°Ô∏è DevSecOps Pipeline ‚Äî B√∫nker Workshop
# Comunidad Claude Anthropic Colombia
# =============================================================================
# Este pipeline implementa security gates en cada etapa:
#   1. Secret scanning (evitar leaks)
#   2. SAST con Bandit (Python) y Semgrep (multi-lenguaje)
#   3. Dependency check (vulnerabilidades en paquetes)
#   4. Container scanning con Trivy
#   5. IaC scanning con tfsec
#   6. Notificaci√≥n al B√∫nker (OpenClaw via Telegram)
# =============================================================================

name: "üîí DevSecOps Pipeline"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE: devsecops-workshop-app
  DOCKER_TAG: ${{ github.sha }}

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 1: Secret Detection
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  secret-scan:
    name: "üîë Secret Scanning"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history para detectar secrets en commits anteriores

      - name: TruffleHog - Detectar secrets expuestos
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Gitleaks - Scanning adicional
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 2: Static Analysis (SAST)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  sast:
    name: "üîç SAST Analysis"
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install security tools
        run: |
          pip install bandit safety
          pip install semgrep

      # Bandit ‚Äî Python SAST
      - name: "Bandit - Python Security Linter"
        run: |
          echo "## üêç Bandit Results" >> $GITHUB_STEP_SUMMARY
          bandit -r . -f json -o bandit-report.json \
            --exclude ./.venv,./tests,./node_modules || true
          bandit -r . -f screen \
            --exclude ./.venv,./tests,./node_modules >> $GITHUB_STEP_SUMMARY || true

      # Semgrep ‚Äî Multi-language SAST
      - name: "Semgrep - Multi-language Scanner"
        run: |
          echo "## üîé Semgrep Results" >> $GITHUB_STEP_SUMMARY
          semgrep --config auto --json -o semgrep-report.json . || true
          semgrep --config auto . >> $GITHUB_STEP_SUMMARY 2>&1 || true

      # Safety ‚Äî Dependency vulnerabilities
      - name: "Safety - Dependency Check"
        run: |
          if [ -f requirements.txt ]; then
            echo "## üì¶ Dependency Check" >> $GITHUB_STEP_SUMMARY
            safety check -r requirements.txt --output json > safety-report.json || true
            safety check -r requirements.txt >> $GITHUB_STEP_SUMMARY || true
          fi

      - name: Upload SAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-reports
          path: |
            bandit-report.json
            semgrep-report.json
            safety-report.json

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 3: Build & Container Scan
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  container-security:
    name: "üê≥ Container Security"
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          docker build -t $DOCKER_IMAGE:$DOCKER_TAG -f docker/app/Dockerfile .

      # Trivy ‚Äî Container vulnerability scanner
      - name: "Trivy - Container Scan"
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}"
          format: "sarif"
          output: "trivy-report.sarif"
          severity: "CRITICAL,HIGH"

      - name: "Trivy - Summary"
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}"
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM"

      # Docker Scout ‚Äî Supply chain analysis
      - name: "Hadolint - Dockerfile Linter"
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: docker/app/Dockerfile

      - name: Upload Container Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-reports
          path: trivy-report.sarif

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 4: Infrastructure as Code Scan
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  iac-security:
    name: "üèóÔ∏è IaC Security"
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - uses: actions/checkout@v4

      - name: "tfsec - Terraform Security"
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: terraform/

      - name: "Checkov - IaC Policy Check"
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          output_format: cli
          soft_fail: true

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 5: Notify B√∫nker (OpenClaw via Telegram)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  notify-bunker:
    name: "üì° Notificar al B√∫nker"
    runs-on: ubuntu-latest
    needs: [sast, container-security, iac-security]
    if: always()
    steps:
      - name: Prepare Security Summary
        id: summary
        run: |
          STATUS="‚úÖ PASSED"
          if [[ "${{ needs.sast.result }}" == "failure" ]] || \
             [[ "${{ needs.container-security.result }}" == "failure" ]] || \
             [[ "${{ needs.iac-security.result }}" == "failure" ]]; then
            STATUS="üö® FAILED"
          fi
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Notify via Telegram (al B√∫nker)
        if: env.TELEGRAM_BOT_TOKEN != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="üõ°Ô∏è *DevSecOps Pipeline Report*%0A"
          MESSAGE+="Repo: \`${{ github.repository }}\`%0A"
          MESSAGE+="Branch: \`${{ github.ref_name }}\`%0A"
          MESSAGE+="Commit: \`${{ github.sha }}\`%0A"
          MESSAGE+="Status: ${{ steps.summary.outputs.status }}%0A"
          MESSAGE+="%0A*Security Gates:*%0A"
          MESSAGE+="‚Ä¢ SAST: ${{ needs.sast.result }}%0A"
          MESSAGE+="‚Ä¢ Container: ${{ needs.container-security.result }}%0A"
          MESSAGE+="‚Ä¢ IaC: ${{ needs.iac-security.result }}"

          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"
