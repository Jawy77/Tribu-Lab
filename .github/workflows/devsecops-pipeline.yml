# =============================================================================
# üõ°Ô∏è DevSecOps Pipeline ‚Äî B√∫nker Workshop
# Comunidad Claude Anthropic Colombia
# =============================================================================
# Este pipeline implementa security gates en cada etapa:
#   1. Secret scanning (evitar leaks)
#   2. SAST con Bandit (Python) y Semgrep (multi-lenguaje)
#   3. Dependency check (vulnerabilidades en paquetes)
#   4. Container scanning con Trivy
#   5. IaC scanning con tfsec
#   6. Notificaci√≥n al B√∫nker (OpenClaw via Telegram)
# =============================================================================

name: "üîí DevSecOps Pipeline"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE: devsecops-workshop-app
  DOCKER_TAG: ${{ github.sha }}

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 1: Secret Detection
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  secret-scan:
    name: "üîë Secret Scanning"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history para detectar secrets en commits anteriores

      - name: TruffleHog - Detectar secrets expuestos
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Gitleaks - Scanning adicional
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 2: Static Analysis (SAST)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  sast:
    name: "üîç SAST Analysis"
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install security tools
        run: |
          pip install bandit safety
          pip install semgrep

      # Bandit ‚Äî Python SAST
      - name: "Bandit - Python Security Linter"
        run: |
          echo "## üêç Bandit Results" >> $GITHUB_STEP_SUMMARY
          bandit -r . -f json -o bandit-report.json \
            --exclude ./.venv,./tests,./node_modules || true
          bandit -r . -f screen \
            --exclude ./.venv,./tests,./node_modules >> $GITHUB_STEP_SUMMARY || true

      # Semgrep ‚Äî Multi-language SAST
      - name: "Semgrep - Multi-language Scanner"
        run: |
          echo "## üîé Semgrep Results" >> $GITHUB_STEP_SUMMARY
          semgrep --config auto --json -o semgrep-report.json . || true
          semgrep --config auto . >> $GITHUB_STEP_SUMMARY 2>&1 || true

      # Safety ‚Äî Dependency vulnerabilities
      - name: "Safety - Dependency Check"
        run: |
          if [ -f requirements.txt ]; then
            echo "## üì¶ Dependency Check" >> $GITHUB_STEP_SUMMARY
            safety check -r requirements.txt --output json > safety-report.json || true
            safety check -r requirements.txt >> $GITHUB_STEP_SUMMARY || true
          fi

      - name: Upload SAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-reports
          path: |
            bandit-report.json
            semgrep-report.json
            safety-report.json

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 3: Check for Dockerfile & Terraform
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  detect-files:
    name: "üìÇ Detect Config Files"
    runs-on: ubuntu-latest
    outputs:
      has_dockerfile: ${{ steps.check.outputs.has_dockerfile }}
      has_terraform: ${{ steps.check.outputs.has_terraform }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for Dockerfile and .tf files
        id: check
        run: |
          if find . -name 'Dockerfile' -type f | grep -q .; then
            echo "has_dockerfile=true" >> $GITHUB_OUTPUT
          else
            echo "has_dockerfile=false" >> $GITHUB_OUTPUT
          fi
          if find . -name '*.tf' -type f | grep -q .; then
            echo "has_terraform=true" >> $GITHUB_OUTPUT
          else
            echo "has_terraform=false" >> $GITHUB_OUTPUT
          fi

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 4: Build & Container Scan (solo si hay Dockerfile)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  container-security:
    name: "üê≥ Container Security"
    runs-on: ubuntu-latest
    needs: [sast, detect-files]
    if: needs.detect-files.outputs.has_dockerfile == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Find Dockerfile
        id: find-dockerfile
        run: |
          DOCKERFILE=$(find . -name 'Dockerfile' -type f | head -1)
          echo "path=$DOCKERFILE" >> $GITHUB_OUTPUT

      - name: Build Docker Image
        run: |
          docker build -t $DOCKER_IMAGE:$DOCKER_TAG -f ${{ steps.find-dockerfile.outputs.path }} .

      # Trivy ‚Äî Container vulnerability scanner
      - name: "Trivy - Container Scan"
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}"
          format: "sarif"
          output: "trivy-report.sarif"
          severity: "CRITICAL,HIGH"

      - name: "Trivy - Summary"
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}"
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: "Hadolint - Dockerfile Linter"
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ steps.find-dockerfile.outputs.path }}

      - name: Upload Container Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-reports
          path: trivy-report.sarif

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 5: Infrastructure as Code Scan (solo si hay .tf files)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  iac-security:
    name: "üèóÔ∏è IaC Security"
    runs-on: ubuntu-latest
    needs: [secret-scan, detect-files]
    if: needs.detect-files.outputs.has_terraform == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Find Terraform directory
        id: find-tf
        run: |
          TF_DIR=$(dirname $(find . -name '*.tf' -type f | head -1))
          echo "dir=$TF_DIR" >> $GITHUB_OUTPUT

      - name: "tfsec - Terraform Security"
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: ${{ steps.find-tf.outputs.dir }}

      - name: "Checkov - IaC Policy Check"
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ${{ steps.find-tf.outputs.dir }}
          framework: terraform
          output_format: cli
          soft_fail: true

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # STAGE 6-7: Notify B√∫nker (Telegram + Discord)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  notify-bunker:
    name: "üì° Notificar al B√∫nker"
    runs-on: ubuntu-latest
    needs: [secret-scan, sast, container-security, iac-security]
    if: always()
    steps:
      - name: Prepare Security Summary
        id: summary
        run: |
          STATUS="‚úÖ PASSED"
          # Solo falla si alg√∫n job fall√≥ (skipped no es fallo)
          if [[ "${{ needs.secret-scan.result }}" == "failure" ]] || \
             [[ "${{ needs.sast.result }}" == "failure" ]] || \
             [[ "${{ needs.container-security.result }}" == "failure" ]] || \
             [[ "${{ needs.iac-security.result }}" == "failure" ]]; then
            STATUS="üö® FAILED"
          fi
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Notify via Telegram (al B√∫nker)
        if: env.TELEGRAM_BOT_TOKEN != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="üõ°Ô∏è *DevSecOps Pipeline Report*%0A"
          MESSAGE+="Repo: \`${{ github.repository }}\`%0A"
          MESSAGE+="Branch: \`${{ github.ref_name }}\`%0A"
          MESSAGE+="Commit: \`${{ github.sha }}\`%0A"
          MESSAGE+="Status: ${{ steps.summary.outputs.status }}%0A"
          MESSAGE+="%0A*Security Gates:*%0A"
          MESSAGE+="‚Ä¢ Secrets: ${{ needs.secret-scan.result }}%0A"
          MESSAGE+="‚Ä¢ SAST: ${{ needs.sast.result }}%0A"
          MESSAGE+="‚Ä¢ Container: ${{ needs.container-security.result }}%0A"
          MESSAGE+="‚Ä¢ IaC: ${{ needs.iac-security.result }}"

          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

      - name: Notify via Discord (al B√∫nker)
        if: env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS="${{ steps.summary.outputs.status }}"
          COLOR=3066993  # verde
          if [[ "$STATUS" == *"FAILED"* ]]; then
            COLOR=15158332  # rojo
          fi

          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"üõ°Ô∏è DevSecOps Pipeline Report\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"Repo\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                  {\"name\": \"Branch\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                  {\"name\": \"Status\", \"value\": \"$STATUS\", \"inline\": false},
                  {\"name\": \"Secrets\", \"value\": \"${{ needs.secret-scan.result }}\", \"inline\": true},
                  {\"name\": \"SAST\", \"value\": \"${{ needs.sast.result }}\", \"inline\": true},
                  {\"name\": \"Container\", \"value\": \"${{ needs.container-security.result }}\", \"inline\": true},
                  {\"name\": \"IaC\", \"value\": \"${{ needs.iac-security.result }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"B√∫nker DevSecOps | Mantishield\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }"
